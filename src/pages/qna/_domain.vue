<template>
  <div class="bg-gray-100 h-screen overflow-x-hidden">
    <div
      class="relative bg-white mx-auto max-w-md min-h-screen px-5 font-secondary"
      :class="thankyouPage
      || domainId === 'nodata'
      || help
      || criteriaProgressCount() >= progressCheckpoint
      || criteriaProgressCount() >= 100
      ? '' : 'pb-36'"
    >
      <!-- Heading -->
      <div class="flex justify-between relative py-5">
        <nuxt-link :to="`/criteria/${domain.toLowerCase()}`">
          <svg
            class="fill-current text-gray-400 absolute left-0 w-4 h-4 hover:text-secondary"
            viewBox="0 0 8 12"
            fill="none"
          >
            <path d="M7.41 10.59L2.83 6L7.41 1.41L6 0L0 6L6 12L7.41 10.59Z" />
          </svg>
        </nuxt-link>
        <h1 v-if="domainId === 'nodata'" class="text-primary text-sm"> ??? </h1>
        <h1 v-else class="text-primary text-sm capitalize">{{ domain }}</h1>
        <div
          class="flex items-center justify-center rounded-full border-2 border-gray-400 h-5 w-5 cursor-pointer"
          @click="help = !help"
        >
          <span v-if="help" class="text-xs text-gray-400">x</span>
          <span v-else class="text-xs text-gray-400">?</span>
        </div>
      </div>
      <!-- Content: Question -->
      <div v-if="thankyouPage || criteriaProgressCount() >= 100"></div>
      <div v-else-if="domainId === 'nodata'"></div>
      <div v-else-if="criteriaProgressCount() >= progressCheckpoint"></div>
      <div v-else class="relative">
        <div class="flex justify-between text-sm text-gray-300 mb-2">
          <span>Pertanyaan</span>
        </div>
        <div class="text-sm text-primary font-bold rounded-xl mb-5">
          Siapa yang kamu rekomendasikan untuk kriteria {{ domain }}
        </div>
      </div>

      <!-- Content: Answer -->
      <Thankyou
        v-if="thankyouPage || criteriaProgressCount() >= 100"
        image="appreciation.svg"
        :buttons="[{
          label: 'Kembali',
          url: '/dashboard',
          theme: 'border-secondary bg-secondary text-white'
        }]"
      >
        <h1 slot="title" class="text-lg text-white  mb-10">
          Terimakasih
        </h1>
      </Thankyou>
      <Thankyou
        v-else-if="domainId === 'nodata'"
        subtitle="Pertanyaan"
        image="appreciation.svg"
        :buttons="[{
          label: 'kembali',
          url: '/dashboard/',
          theme: 'border-secondary bg-secondary text-white'
        }]"
      >
        <h1 slot="title" class="text-lg text-white  mb-10">
          Data dari criteria <span class="text-secondary">{{ domain }},</span> tidak ditemukan
        </h1>
      </Thankyou>
      <div
        v-else-if="criteriaProgressCount() > progressCheckpoint"
        class="flex items-center relative bg-primary -mx-5" style="height: calc(100vh - 60px);"
      >
        <div class="flex flex-col justify-center items-center text-white text-center px-5 w-full">
          <img class="mb-10 w-60" src="~/static/img/svg/checkpoint.svg" alt="description domain" />
          <h1 class="text-base mb-8 max-w-xs font-mulish font-bold">
            Kamu sudah mencapai <span class="text-secondary">{{ criteriaProgressCount() }}%</span>
          </h1>
          <p class="text-sm max-w-sm mb-4">Jika ingin menunda untuk melanjutkan proses pemilihan di domain ini, kamu bisa memilih “Lanjutkan Nanti”</p>
          <p class="text-sm max-w-sm mb-4">Kamu juga bisa melanjutkan pemilihan alterrans lainnya untuk domain ini dengan cara memilih “Lanjutkan” untuk dapat memilih hingga ke milestone berikutnya</p>
          <div class="flex space-x-4 mt-10">
            <nuxt-link to="/dashboard" class="rounded-full py-2 px-4 border border-solid border-secondary bg-white hover:bg-secondary  hover:text-white text-secondary focus:outline-none flex items-center mx-auto justify-center inline-block">
              Lanjutkan Nanti
            </nuxt-link>
            <button
              @click="progressCheckpoint += 1"
              class="rounded-full py-3 px-8 border border-solid border-secondary bg-secondary hover:bg-yellow-700 text-white focus:outline-none flex items-center mx-auto justify-center inline-block"
            >
              Lanjutkan
            </button>
          </div>
        </div>
      </div>
      <div class="relative" v-else>
        <p class="text-xs text-gray-300 mb-3">Pilih 3 Alterrans rekomendasi kamu</p>
        <div class="grid grid-cols-2 xs:grid-cols-3 gap-5">
          <div
            v-for="(item, i) in answersObject"
            :key="i"
            @click="answerAdd(item.email)"
            class="relative"
          >
            <div
              class="absolute top-2 right-2 bg-white rounded-full text-white flex items-center justify-center z-10"
              v-show="selectedAnswer.includes(item.email)"
            >
              <svg class="fill-current text-success" width="30" height="30" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM8 15L3 10L4.41 8.59L8 12.17L15.59 4.58L17 6L8 15Z"/>
              </svg>
            </div>
            <div
              class="rounded-xl overflow-hidden cursor-pointer"
              :class="
                selectedAnswer.length < 3
                  ? `${selectedAnswerClass(item.email)} hover:opacity-50`
                  : `${selectedAnswerClass(item.email)}`
              "
            >
              <div class="bg-gray-50">
                <v-lazy-image v-if="item.image" :src="item.image" src-placeholder="/img/blank.jpeg" :alt="item.name" />
                <img v-else class="" src="~/static/img/blank.jpeg" :alt="item.name" />
              </div>
              <div class="flex justify-center bg-white text-sm px-2 py-1 autotrim">
                <small class="text-primary">{{ item.name }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation Footer -->
      <div v-if="thankyouPage || domainId === 'nodata'" class="fixed bottom-0 left-0 right-0"></div>
      <div v-else-if="criteriaProgressCount() >= progressCheckpoint"></div>
      <div v-else class="fixed bottom-0 left-0 right-0">
        <div
          class="mx-auto max-w-md bg-white bg-white rounded-b-xl shadow-lg w-full h-2 transform rotate-180"
        ></div>
        <div
          class="mx-auto max-w-md bg-white px-5 pb-2 bg-white rounded-t-xl shadow-lg"
        >
          <p class="text-xs text-gray-300">Progress</p>
          <div class="flex items-center justify-center mb-2">
            <div class="relative pr-2 w-full">
              <div class="overflow-hidden h-2 text-xs flex rounded bg-gray-200">
                <div :style="`width:${ criteriaProgressCount() }%`" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-primary"></div>
              </div>
            </div>
            <span class="text-xs inline-block text-primary">{{ criteriaProgressCount() }}%</span>
          </div>
          <div class="flex justify-between items-center">
            <div class="relative">
              <p class="text-xs text-gray-300 mb-2">
                Terpilih {{ selectedAnswer.length }} dari {{ maxSelectedAnswer }}
              </p>
              <div class="flex h-10">
                <div
                  v-for="(item, i) in selectedAnswer"
                  :key="i"
                  @click="answerAdd(item)"
                >
                  <img
                    v-if="selectedAnswerImage(item)"
                    :class="
                      `w-9 h-9 border border-gray-300 border-dashed rounded-full relative ${indenClass[i]}`
                    "
                    :src="selectedAnswerImage(item)"
                    :alt="item"
                  />
                  <img
                    v-else
                    :class="
                      `w-9 h-9 border border-gray-300 border-dashed rounded-full relative ${indenClass[i]}`
                    "
                    src="~/static/img/blank.jpeg"
                    :alt="item"
                  />
                </div>
              </div>
            </div>
            <div class="inline-block flex">
              <button
                :disabled="loading"
                @click="nextPage(); progressCounter+=5"
                class="ml-2 rounded-full py-2 px-4 border border-solid border-secondary bg-secondary hover:bg-yellow-700 text-white focus:outline-none flex items-center mx-auto justify-center inline-block"
              >
                <svg v-show="loading" class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="font-bold text-sm">
                  <!-- {{ buttonLabel() }} -->
                  Lanjut
                </span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Help -->
      <Help
        title="Domain Requirements"
        :show="help"
      >
        <p slot="content" class="mb-5">
          1. User dapat memilih maximal 3 alterran dari 9 alterran yg dirasa sesuai dengan <span class="text-secondary">Requirement</span>
          <img src="~/static/img/screenshoot/image1.png" alt="screenshoot1" class="w-60 rounded-lg mt-4">
        </p>
        <p slot="content">
          2. Alterran yg dipilih adalah alterran yang dirasa paling baik dalam bidang requirment
        </p>
        <p slot="content" class="mb-5">
          3. Jika tidak ada yang dirasa sesuai, pilih tombol "selanjutnya" untuk memuat ulang data alterran yg ditampilkan
        </p>
        <p slot="content" class="mb-5">
          4. Progress bar berikut mengindikasikan Lorem Ipsum is simply
          dummy text of the printing and typesetting industry.
          <img src="~/static/img/screenshoot/image2.png" alt="screenshoot1" class="rounded-lg mt-4">
        </p>
        <p slot="content" class="mb-5">
          5. User dapat memilih maximal 3 alterran dari 9 alterran yg dirasa sesuai dengan <span class="text-secondary">Requirement</span>
          <img src="~/static/img/screenshoot/image1.png" alt="screenshoot1" class="w-60 rounded-lg mt-4">
        </p>
        <p slot="content">
          6. Alterran yg dipilih adalah alterran yang dirasa paling baik dalam bidang requirment
        </p>
        <p slot="content" class="mb-5">
          7. Jika tidak ada yang dirasa sesuai, pilih tombol "selanjutnya" untuk memuat ulang data alterran yg ditampilkan
        </p>
        <p slot="content" class="mb-5">
          8. Progress bar berikut mengindikasikan Lorem Ipsum is simply
          dummy text of the printing and typesetting industry.
          <img src="~/static/img/screenshoot/image2.png" alt="screenshoot1" class="rounded-lg mt-4">
        </p>
        <p slot="content" class="mb-5">
          9. User dapat memilih maximal 3 alterran dari 9 alterran yg dirasa sesuai dengan <span class="text-secondary">Requirement</span>
          <img src="~/static/img/screenshoot/image1.png" alt="screenshoot1" class="w-60 rounded-lg mt-4">
        </p>
        <p slot="content">
          10. Alterran yg dipilih adalah alterran yang dirasa paling baik dalam bidang requirment
        </p>
        <p slot="content" class="mb-5">
          11. Jika tidak ada yang dirasa sesuai, pilih tombol "selanjutnya" untuk memuat ulang data alterran yg ditampilkan
        </p>
        <p slot="content" class="mb-5">
          12. Progress bar berikut mengindikasikan Lorem Ipsum is simply
          dummy text of the printing and typesetting industry.
          <img src="~/static/img/screenshoot/image2.png" alt="screenshoot1" class="rounded-lg mt-4">
        </p>

      </Help>
    </div>
  </div>
</template>

<script lang="ts">
import { Vue, Component } from 'vue-property-decorator';
import { qnaModule } from '@/store/qna';
import Thankyou from '~/components/utilities/Thankyou.vue';
import Help from '~/components/utilities/Help.vue';

export interface QnaResponseData {
  /* eslint-disable camelcase */
  criteria_id: string;
  criteria_name: string;
  employee_name_x: string;
  employee_name_y: string;
  employee_email_x: string;
  employee_email_y: string;
  employee_image_url_x: string;
  employee_image_url_y: string;
  /* eslint-enable camelcase */
}
export interface QnaResponse {
  /* eslint-disable-next-line camelcase */
  response_code: string;
  message: string;
  data: QnaResponseData[] | string | number;
}
export interface QnaSubmit {
  /* eslint-disable camelcase */
  criteria_id?: string | (string | null)[];
  selected_employee_email?: string;
  employee_email_x?: string;
  employee_email_y?: string;
  /* eslint-enable camelcase */
}
@Component({
  components: { Thankyou, Help },
})
export default class Qna extends Vue {
  domain: string = '';

  domainId: string = 'nodata';

  employees: QnaResponseData[] = [];

  questions: string = '';

  local: string | null = localStorage.getItem('rss_criteria');

  loading: boolean = true;

  help: boolean = false;

  progressCounter: number = 0;

  progressCheckpoint: number = 1;

  // data answer
  selectedAnswer: string[] = [];

  allSelectedAnswer: string[][] = [];

  answers: string[] = [];

  answersObject: { name?: string; email?: string; image?: string; }[] = [];

  maxSelectedAnswer = 3;

  indenClass: string[] = ['', '-left-2', '-left-3.5'];

  // pagination
  pages: number = 999;

  currentPages: number = 1;

  thankyouPage: boolean = false;

  async getUniqueEmployees() {
    // buat array unique employee
    try {
      this.employees.forEach((e) => {
        // check employee x
        if (!this.answers.includes(e.employee_email_x)) {
          // add data
          this.answers.push(e.employee_email_x);
          // add detail data
          this.answersObject.push({
            name: e.employee_name_x,
            email: e.employee_email_x,
            image: e.employee_image_url_x,
          });
        }
        // check employee y
        if (!this.answers.includes(e.employee_email_y)) {
          // add data
          this.answers.push(e.employee_email_y);
          // add detail data
          this.answersObject.push({
            name: e.employee_name_y,
            email: e.employee_email_y,
            image: e.employee_image_url_y,
          });
        }
      });
      await this.checkDataAnswer();
    } catch (e) {
      // error code
    }
  }

  async checkDataAnswer() {
    // cek jika belum mendapatkan 9 unique employee
    if (this.employees.length === 0) { this.thankyouPage = true; }
    if (this.answers.length < 9 && this.employees.length >= 10) {
      // get 3 data lagi sampai dapat 9 unique employee
      await this.loadEmployeeData();
    } else {
      this.answers.splice(9);
      this.answersObject.splice(9);
    }
  }

  selectedAnswerImage(email: string) {
    const i = this.answersObject.filter(
      (ao) => ao.email === email,
    );
    return i[0]?.image;
  }

  prepareSubmit(): QnaSubmit[] {
    const data: QnaSubmit[] = [];
    this.selectedAnswer.forEach((emailX) => {
      this.answers.forEach((emailY) => {
        if (!this.selectedAnswer.includes(emailY)) {
          data.push({
            criteria_id: this.domainId,
            selected_employee_email: emailX,
            employee_email_x: emailX,
            employee_email_y: emailY,
          });
        }
      });
    });
    return data;
  }

  async nextPage(): Promise<void> {
    this.loading = true;
    if (this.pages > this.currentPages) {
      // Submit this.prepareSubmit() via this.submitEmployeeData() and recall this.loadEmployeeData()
      await this.submitEmployeeData();
      // success : console.log(response.response_code === '0000')
      // reload data
      this.answers.splice(0);
      this.answersObject.splice(0);
      await this.loadEmployeeData().then(() => { this.loading = false; });
      // go to the next page
      this.allSelectedAnswer.push(this.selectedAnswer);
      this.selectedAnswer = [];
      this.currentPages += 1;
    } else {
      this.thankyouPage = true;
    }
  }

  buttonLabel(): string {
    if (this.selectedAnswer.length > 0) {
      return this.currentPages === this.pages ? 'Selesai' : 'Selanjutnya';
    }
    return this.currentPages === this.pages ? 'Selesai' : 'Lewati';
  }

  selectedAnswerClass(email: string): string {
    return this.selectedAnswer.includes(email)
      ? 'opacity-30 shadow-md'
      : 'shadow-lg';
  }

  answerAdd(email: string): void {
    const index = this.selectedAnswer.indexOf(email);
    if (index === -1) {
      if (this.selectedAnswer.length < this.maxSelectedAnswer) {
        this.selectedAnswer.push(email);
      }
    } else {
      this.selectedAnswer.splice(index, 1);
    }
  }

  init() {
    if (this.local) {
      const domain = JSON.parse(this.local);
      const url = this.$route.params.domain;
      if (domain.criteria_name.toLowerCase() === url) {
        this.domain = domain.criteria_name;
        this.domainId = domain.id;
      }
      // set initial progress
      qnaModule.setSubmit({
        response_code: '',
        message: '',
        data: {
          count_submitted: 0,
          percent_progress: domain.percent_progress,
        },
      });
      // set initial checkpoint progress
      this.progressCheckpoint = domain.percent_progress + 1;
    }
  }

  async loadEmployeeData(): Promise<void> {
    await qnaModule.getQna({
      criteria_id: this.domainId,
      limit: 10,
    });
    this.employees = qnaModule.dataQna.data;
    this.getUniqueEmployees();
  }

  async submitEmployeeData(): Promise<QnaResponse | object> {
    const local = this.local ? JSON.parse(this.local) : '';
    if (this.prepareSubmit().length) {
      await qnaModule.submitQna(this.prepareSubmit(), local.id);
      return qnaModule.dataQna;
    }
    return {};
  }

  mounted() {
    // initial domain
    this.init();
    if (this.domainId !== 'nodata' && typeof this.domainId !== 'undefined') {
      // load employee data
      this.loadEmployeeData().then(() => { this.loading = false; });
    }
  }

  criteriaProgressCount() {
    if (this.local) {
      const local = JSON.parse(this.local);
      return qnaModule.submitResponse.data.percent_progress === 0
        ? local.percent_progress.toFixed(2)
        : qnaModule.submitResponse.data.percent_progress.toFixed(2);
    }
    return 0;
  }
}
</script>

<style>
.autotrim {
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  position: relative;
  height: 28px;
  min-height: 28px;
}
</style>
